<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dgit.persistence.ReviewsDAO">

	<sql id="wheresql_rno">
		where rno = #{rno}
	</sql>
	<select id="reviewsListAll" resultType="ReviewsVO">
		select * from reviews
		where rno > 0
		order by rno desc, rregdate desc
	</select>
	
	<select id="getMaxRno" resultType="int">
		select MAX(rno)+1 from reviews
	</select>
	
	<select id="reviewsSelectByNo" resultType="ReviewsVO">
		SELECT * FROM reviews
		<include refid="wheresql_rno"/>
	</select>
	
	<select id="listSearch" resultType="ReviewsVO">
		SELECT * FROM reviews
		<include refid="search"/>
		order by rno desc,rregdate desc
		limit #{pageStart},#{perPageNum}
	</select>
	
	<select id="searchCount" resultType="int">
		select count(*) from reviews 
		<include refid="search"/>
	</select>
	
	<sql id="search">
		<if test="searchType !=null">
			<if test="searchType =='t'.toString()">
				where rtitle like CONCAT('%',#{keyword},'%')
			</if>
			<if test="searchType =='c'.toString()">
				where rcontent like CONCAT('%',#{keyword},'%')
			</if>
			<if test="searchType =='w'.toString()">
				where uid like CONCAT('%',#{keyword},'%')
			</if>
			<if test="searchType =='tc'.toString()">
				where rtitle like CONCAT('%',#{keyword},'%') or rcontent like CONCAT('%',#{keyword},'%')
			</if>
			<if test="searchType =='cw'.toString()">
				where rcontent like CONCAT('%',#{keyword},'%') or uid like CONCAT('%',#{keyword},'%')
			</if>
			<if test="searchType =='tcw'.toString()">
				where rtitle like CONCAT('%',#{keyword},'%') or rcontent like CONCAT('%',#{keyword},'%') or uid like CONCAT('%',#{keyword},'%')
			</if>
		</if>
	</sql>
	
	<insert id="reviewsInsert">
		INSERT INTO reviews
		(rno, gcode, uid, rtitle, rcontent, rregdate, ocode)
		VALUES(#{rno}, #{gcode}, #{uid}, #{rtitle}, #{rcontent}, CURRENT_TIMESTAMP,#{ocode})
	</insert>
	
	<update id="reviewsUpdate">
		UPDATE reviews
		SET rtitle=#{rtitle}, rcontent=#{rcontent}
		<include refid="wheresql_rno"/>
	</update>

	<delete id="reviewsDelete">
		DELETE FROM  reviews
		<include refid="wheresql_rno"/>
	</delete>
	
</mapper>